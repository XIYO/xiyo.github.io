#!/bin/sh

# prepare-commit-msg hook
# $1 = commit message file path
# $2 = commit source (message, template, merge, squash, commit)
# $3 = commit SHA (for amend/commit -c)

echo "ğŸ“ Running prepare-commit-msg hook..."

# ì»¤ë°‹ ë©”ì‹œì§€ ì½ê¸°
COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"

# í”„ë¡ íŠ¸ë§¤í„° ì—…ë°ì´íŠ¸ ë°©ì§€ ì²´í¬ (ë¬´í•œë£¨í”„ ë°©ì§€)
if [ "$FRONTMATTER_UPDATE_RUNNING" = "1" ]; then
  echo "ğŸ”„ í”„ë¡ íŠ¸ë§¤í„° ì—…ë°ì´íŠ¸ ì¤‘ì´ë¯€ë¡œ ê±´ë„ˆëœë‹ˆë‹¤."
  exit 0
fi

# íŠ¹ì • ìƒí™©ì—ì„œë§Œ ì‹¤í–‰ (ì¼ë°˜ ì»¤ë°‹, merge ì œì™¸)
if [ "$COMMIT_SOURCE" = "message" ] || [ -z "$COMMIT_SOURCE" ]; then
  echo "ğŸ” Processing frontmatter for markdown files..."
  
  # í˜„ì¬ ì»¤ë°‹ ë©”ì‹œì§€ ì½ê¸°
  CURRENT_MSG=$(cat "$COMMIT_MSG_FILE")
  
  # ìŠ¤í…Œì´ì§•ëœ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ë“¤ ì°¾ê¸°
  STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)
  
  if [ -n "$STAGED_MD_FILES" ]; then
    echo "ğŸ“„ Found staged markdown files:"
    echo "$STAGED_MD_FILES"
    
    # í™˜ê²½ë³€ìˆ˜ ì„¤ì •í•˜ì—¬ ë¬´í•œë£¨í”„ ë°©ì§€
    export FRONTMATTER_UPDATE_RUNNING=1
    export COMMIT_MESSAGE="$CURRENT_MSG"
    
    if pnpm exec node scripts/update-frontmatter-prepare.js; then
      echo "âœ… Frontmatter updated and re-staged successfully"
    else
      echo "âŒ Frontmatter update failed"
      exit 1
    fi
    
    # í™˜ê²½ë³€ìˆ˜ í•´ì œ
    unset FRONTMATTER_UPDATE_RUNNING
  else
    echo "â„¹ï¸  No staged markdown files found"
  fi
else
  echo "â© Skipping frontmatter update for commit source: $COMMIT_SOURCE"
fi

echo "âœ… prepare-commit-msg completed"